<html>

	<head>
		<title>Stock Chart...</title>
		<meta charset="utf-8">
		<style type="text/css">
			body {
				min-height: 100vh;
				padding-right: 0px;
				padding-left: 0px;
    				background-image: linear-gradient(144deg, #0c0016, #39BD8B);
    				background-size: 100% auto;
				color: white;
			}
			h3{
				color:white;
			}
		</style>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">		

		
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
		<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.bundle.min.js"></script>
		<script src="https://github.com/hasura/js-sdk/releases/download/v0.1.4/hasura.min.js"></script>
		
		<script>
          		window.chartColors={red:'rgb(255, 99, 132)',orange:'rgb(255, 159, 64)',yellow:'rgb(255, 205, 86)',green:'rgb(75, 192, 192)',blue:'rgb(54, 162, 235)',purple:'rgb(153, 102, 255)',grey:'rgb(201, 203, 207)'}
		</script>
		
		<script>
			$(document).ready(function(){
				hasura.setProject('alike21');
				
				function makeDropdown(data){
					console.log("Got this data: ");
					console.log(data);
					
					var sectors = [];
	
					sel = $("#dropdown-select");
					$.each(data, function(k, v){
                      				if (sectors.indexOf(v.sector_name.toString()) < 0){
                        				sectors.push(v.sector_name.toString());
                        				sel.append('<option value="' + v.sector_name + '">' + v.sector_name + '</option>');
                      			}});
				
				}

				hasura.data.query({
					type:'select',
					args: {
						table: 'stocks',
						columns: ['*']
					}},
					(data) => {makeDropdown(data)},
					(error) => {console.log(error);});

				console.log("Now we get data from the hasura platform");

				$("#dropdown-select").on('change', function(e){
					var sector = $('#dropdown-select').val();
					console.log(sector);
					hasura.data.query({
                                        	type:'select',
                                        	args: {
                                                	table: 'stocks',
                                                	columns: ['*', {
                                                        	name : "financials",
                                                        	columns : ["*","year"],
								order_by: "+year"
                                                	}],
                                                	where: {
                                                        	sector_name:sector
                                                	}
                                        	}},
                                        	(data) => {drawChart(data);},
                                        	(error) => {console.log(error);}
					);
					hasura.data.query({
                                                type:'select',
                                                args: {
                                                        table: 'stocks',
                                                        columns: ['*', {
                                                                name : "financials",
                                                                columns : ["*","year"],
                                                                order_by: "+year"
                                                        }],
                                                        where: {
                                                                sector_name:sector
                                                        }
                                                }},
                                                (data) => {drawRevChart(data);},
                                                (error) => {console.log(error);}
                                        );
					
					function drawChart(sectors) {

						$("#canvas").remove();
						$("#canvas-container").append('<canvas id="canvas"></canvas>');

						var canvas = document.getElementById('canvas');
                      				var ctx = canvas.getContext('2d');
						var datasets = [];
						var index = 0;
					
						$.each(sectors,function(k,company) {
							var color = window.chartColors[Object.keys(window.chartColors)[index%7]];
							index += 1;
							var dataset = {
								label: company.stock_name,
								backgroundColor: color,
								borderColor: color,
								data : [
									company.financials[0].pe_ratio,
									company.financials[1].pe_ratio,
									company.financials[2].pe_ratio
								],
								fill:false
							}
							datasets.push(dataset);
						});

						var data = {
							labels: ['2014','2015','2016'],
							datasets: datasets
						}
						var opts = {
							responsive: false,
                					title:{
                    						display:true,
                    						text: sectors[0].sector_name + ' PE Chart Ratio'
                					},
                					tooltips: {
                    						mode: 'index',
                    						intersect: false,
                					},
                					hover: {
                    						mode: 'nearest',
                    						intersect: true
                					},
                					scales: {
                    						xAxes: [{
                        						display: true,
                        						scaleLabel: {
                            							display: true,
                            							labelString: 'Year'
                        						}
                    						}],
                    						yAxes: [{
                        						display: true,
                        						scaleLabel: {
                            							display: true,
                            							labelString: 'PE Ratio'
                        						}
                    						}]
                					}
						}
						canvas.width = 600;
						canvas.height = 400;
						window.myChart = new Chart(ctx, {type:'line',data: data,options:opts});
                                        	console.log("Chart created");
					}

					function drawRevChart(sectors) {

                                                $("#canvas-revenue").remove();
                                                $("#canvas-container-revenue").append('<canvas id="canvas-revenue"></canvas>');

                                                var canvas = document.getElementById('canvas-revenue');
                                                var ctx = canvas.getContext('2d');
                                                var datasets = [];
                                                var index = 0;

                                                $.each(sectors,function(k,company) {
                                                        var color = window.chartColors[Object.keys(window.chartColors)[index%7]];
                                                        index += 1;
                                                        var dataset = {
                                                                label: company.stock_name,
                                                                backgroundColor: color,
                                                                borderColor: color,
                                                                data : [
                                                                        company.financials[0].total_revenue,
                                                                        company.financials[1].total_revenue,
                                                                        company.financials[2].total_revenue
                                                                ],
                                                                fill:false
                                                        }
                                                        datasets.push(dataset);
                                                });

                                                var data = {
                                                        labels: ['2014','2015','2016'],
                                                        datasets: datasets
                                                }
                                                var opts = {
                                                        responsive: false,
                                                        title:{
                                                                display:true,
                                                                text: sectors[0].sector_name + ' Revenue Chart'
                                                        },
                                                        tooltips: {
                                                                mode: 'index',
                                                                intersect: false,
                                                        },
                                                        hover: {
                                                                mode: 'nearest',
                                                                intersect: true
                                                        },
                                                        scales: {
                                                                xAxes: [{
                                                                        display: true,
                                                                        scaleLabel: {
                                                                                display: true,
                                                                                labelString: 'Year'
                                                                        }
                                                                }],
                                                                yAxes: [{
                                                                        display: true,
                                                                        scaleLabel: {
                                                                                display: true,
                                                                                labelString: 'Revenue'
                                                                        }
                                                                }]
                                                        }
                                                }
                                                canvas.width = 600;
                                                canvas.height = 400;
                                                window.myChart = new Chart(ctx, {type:'line',data: data,options:opts});
                                                console.log("Revenue Chart created");
                                        }
				});

			});
		</script>
	</head>

	<body>

		<h3><strong><i>Welcome to Stock Metrics Beta Verison</i><strong></h3>

		<select id="dropdown-select">
                	<option value="default">Select a Sector</option>
        	</select>
		
		<div class="row">
  		<div class="col-6"><div id="canvas-container"><canvas id="canvas"></canvas></div></div>
  		<div class="col-6"><div id="canvas-container-revenue"><canvas id="canvas-revenue"></canvas></div></div>
</div>
	</body>

</html>
